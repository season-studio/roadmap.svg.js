!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("regenerator-runtime")):"function"==typeof define&&define.amd?define(["regenerator-runtime"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).RoadmapSVG=e(t.regeneratorRuntime)}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}function r(t,e,r,n,a,i,o){try{var s=t[i](o),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,a)}function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function a(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function i(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function o(t){return function(t){if(Array.isArray(t))return i(t)}(t)||function(t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t))return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return i(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var s=e(t).default;function c(t,e){if(t)return t;throw"function"==typeof e?e.apply(void 0,Array.prototype.slice.call(arguments).slice(2)):e}function u(t){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function l(t,e,r){if(t&&e)if("object"===u(e))for(var n in e)Object.defineProperty(t,n,{value:e[n],writable:!1,enumerable:!0});else Object.defineProperty(t,e,{value:r,writable:!1,enumerable:!0});return t}var f=Object.freeze({SVG:"http://www.w3.org/2000/svg",ROADMAP:"https://season-studio.github.io/roadmap/"});function m(t){var e=this.length,r=this.$lastLocation,n=0;do{var a=this[r];if(t<a.$startTime)n||(n=-1);else{if(!(t>=a.$endTime))return this.$lastLocation=r,a;n||(n=1)}r+=n}while(r>=0&&r<e)}function d(t){var e=t-this.$startTime,r=this.$timeLength;return e<0?e=0:e>r&&(e=r),this.$layoutStart+this.$layoutSize/r*e}function p(t,e){var r=0;return t.forEach((function(t){var n=t.$layouts;n instanceof Array?r+=p(n,e):t instanceof Node&&(r+=t.$layoutUnit=Number(t.getAttribute("r:time-layout-unit"))||1,isNaN(t.$startTime=Date.parse(t.getAttribute("r:time-start")))&&(t.$startTime=0),isNaN(t.$endTime=Date.parse(t.getAttribute("r:time-end")))&&(t.$endTime=void 0),e.push(t))})),r}function h(t){t.$lastLocation=0;for(var e=void 0,r=t.length-1;r>=0;r--){var n=t[r];void 0===e?e=n.$endTime:(n.$endTime=e,e=n.$startTime),c(e>=n.$startTime,"end time is less than start time"),n.$timeLength=n.$endTime-n.$startTime}}var y=[31,function(t){return t%4==0&&t%100!=0||t%400==0?29:28},31,30,31,30,31,31,30,31,30,31];function g(t,e){var r=y[e];return"function"==typeof r?r(t):r}function v(t){!(t instanceof Date)&&(t=new Date(t));var e=new Date(this[0].$startTime),r=t.getFullYear(),n=r-e.getFullYear(),a=t.getMonth(),i=a-e.getMonth(),o=t.getDate(),s=o===g(r,a),c=t.getHours(),u=t.getMinutes(),l=t.getSeconds(),f=function(t){var e=(t=new Date(t)).getMonth(),r=t.getFullYear()+n,a=e+i;a>12&&(r+=1,a-=12);var f=s?g(r,a):o;return new Date(r,a,f,c,u,l,0).getTime()};this.forEach((function(t){t.$startTime=f(t.$startTime)}));var m=this.length-1;this[m].$endTime=f(this[m].$endTime),h(this)}function b(t){var e=this;c(t instanceof Array,"the parameter must be an array");var r=this.length;t.map((function(t,e){var r=new Date(t).getTime();if(isNaN(r))throw"the parameter[".concat(e,"] is not avaliable time");return r})).forEach((function(t,n){n<r?e[n].$startTime=t:e[r-1].$endTime=t})),h(this)}function S(){this.forEach((function(t){isNaN(t.$startTime=Date.parse(t.getAttribute("r:time-start")))&&(t.$startTime=0),isNaN(t.$endTime=Date.parse(t.getAttribute("r:time-end")))&&(t.$endTime=void 0)})),h(this)}function $(t,e){t instanceof Array&&e instanceof Array&&e.forEach((function(e,r){null!=e&&(t[r].textContent=void 0!==e.text?e.text:e,e.subGroup&&$(t.$layouts,e.subGroup))}))}function w(t){t instanceof Array&&t.forEach((function(t){t.textContent=t.$defaultText,t.$layouts&&w(t.$layouts)}))}function T(t){var e=o(t.querySelectorAll("[r\\:time]")),r=[];e.forEach((function(t){for(var e,n,a={$layouts:r},i=String(t.getAttribute("r:time")).split("-"),o=i.length-1,s=0;s<o;s++)e=i[s],n=a.$layouts||(a.$layouts=[]),a=n[e]||(n[e]={});e=i[o];var c=(n=a.$layouts||(a.$layouts=[]))[e];n[e]=t,c&&(t.$layouts=c.$layouts),t.$defaultText=t.textContent}));var n=[];n.$unitCount=p(r,n),h(n);var a=n[0],i=n[n.length-1];Object.defineProperties(this,{$layouts:{value:r,writable:!1},$firstScale:{value:a,writable:!1},$lastScale:{value:i,writable:!1},$startTime:{get:function(){return a.$startTime}},$endTime:{get:function(){return i.$endTime}},$scaleItems:{value:n,writable:!1}}),this.modifyTime=v.bind(n),this.setTimeScales=b.bind(n),this.restoreTimeScales=S.bind(n),this.setDisplay=function(t){$(r,t)},this.restoreDisplay=function(){return w(r)},this.findItem=m.bind(n);var s=t.querySelector("[r\\:time-scale-size]"),c=(s?(s.getBBox||s.getBoundingClientRect).call(s,{stroke:!0})[s.getAttribute("r:time-scale-size")]:0)/n.$unitCount,u=0;n.forEach((function(t){t.$layoutSize=c*t.$layoutUnit,t.$layoutStart=u,t.$layoutEnd=u+=t.$layoutSize,t.getLayoutLocation=d.bind(t)})),Object.seal(this)}function x(t,e,r){t.setAttribute(e,r)}function A(t,e,r){t.style[e]=r}function D(t,e,r){t.textContent=r}var j=Symbol("roadmap.expression.drop"),z=Symbol("roadmap.expression.break"),E=Symbol("roadmap.expression.exit"),N=[j,z,E],M={$show:function(t,e,r){!r&&t.remove()},$break:function(t,e,r){if(r)throw z},$exit:function(t,e,r){if(r)throw E}};function k(t,e){this.value=t,this.error=e}function R(t,e){try{var r=t[0],n=t[1];if(r===n)throw e;if("function"==typeof n){if(n(r))throw e}else if(t.length<=1&&!r)throw e;return r}catch(t){if(t instanceof k)return t;throw t}}var I={break:function(t,e){return R(arguments,new k(t,z))},exit:function(t,e){return R(arguments,new k(t,E))},drop:function(t,e){return R(arguments,j)}};function C(t,e,r,n){try{this.forEach((function(a){var i=a.fn,o=a.setter,s=a.key,c=a.expression;try{if("function"==typeof i){var u=i.call(t,e,r,n,I);if(u instanceof k)throw"function"==typeof o&&o(t,s,u.value),u.error;"function"==typeof o&&o(t,s,u)}}catch(t){if(N.includes(t)){if(t!==j)throw t}else console.error("[Dynamic Expression Run Fail]",c),console.error(t)}}))}catch(t){return t}}function P(t){var e=String(t).split(";").map((function(t){if(t=t.trim()){var e,r=t.split(/(?<!\=[^\=]*)=/),n=r[0],a=r[1];""===(n=n.trim())?e=void 0:"@"===n[0]?(e=A,n=n.substr(1)):e="$"===n[0]?M[n]:":"===n[0]?D:x;try{return{fn:new Function("project","item","layout","$","return (".concat(a,")")),setter:e,key:n,expression:a}}catch(t){return console.error("[Dynamic Expression Parse Fail]",a),{}}}}));return C.bind(e)}var L=[{caption:"Normal Project",state:"normal",items:[{text:"DR1",start:"2021/01/10",end:"2021/01/20",state:"finish",progress:1},{text:"DR2",start:"2021/01/20",end:"2021/02/01",state:"finish",progress:1},{text:"DR3",start:"2021/02/01",end:"2021/04/15",state:"normal",progress:.5},[[{text:"DR4",start:"2021/04/15",end:"2021/04/30",state:"",progress:.1},{text:"DR5",start:"2021/05/07",end:"2021/06/10",state:""},{text:"DR6",start:"2021/06/10",end:"2021/07/05",state:""}],[{text:"tender",start:"2021/06/24",end:"2021/06/26",state:""},{text:"experimental",start:"2021/06/30",end:"2021/08/17",state:""}]],{text:"be online",start:"2021/09/01",end:"2021/09/02",state:""}]},{caption:"Warn Project",state:"warn",items:[{text:"DR1",start:"2021/03/08",end:"2021/03/30",state:"finish",progress:1},{text:"DR2",start:"2021/03/30",end:"2021/04/10",state:"finish",progress:1},{text:"DR3",start:"2021/04/10",end:"2021/05/26",state:"delay",progress:.2},{text:"DR4",start:"2021/06/01",end:"2021/06/15",state:"",progress:0},[[{text:"DR5",start:"2021/06/17",end:"2021/07/15",state:"",progress:0},{text:"DR6",start:"2021/07/20",end:"2021/08/10",state:"",progress:0}],{text:"DEMO",start:"2021/06/26",end:"2021/07/07",state:"",progress:0}]]}],O=Symbol("roadmap.timeScales"),q=Symbol("roadmap.dyncFunctions");function G(t,e,r,n,a){var i=this[q].get(t.getAttribute(e));return"function"==typeof i&&i(t,r,n,a)}function F(t,e,r,n,a){var i=this;o(t.querySelectorAll("[".concat(e.replace(":","\\:"),"]"))).forEach((function(t){var o=i[q].get(t.getAttribute(e));"function"==typeof o&&o(t,r,n,a)}));var s=this[q].get(t.getAttribute(e));"function"==typeof s&&s(t,r,n,a)}function B(t,e,r,n){var a=this,i=this.template,o=[],s=n.itemLocalIndex,c=0;n.itemLocalIndex=0,t.forEach((function(t){if(t instanceof Array){c++;var s=document.createElementNS(f.SVG,"g");if(s){e.appendChild(s),o.push(s);var u=0;t.forEach((function(t){var e=document.createElementNS(f.SVG,"g");e&&(s.appendChild(e),B.call(a,t instanceof Array?t:[t],e,r,n),i.setTransform(e,u,0),u+=i.getSize(e)+a.parameters.itemMargin)}))}}else{var l="number"==typeof t.start?t.start:Date.parse(t.start),m="number"==typeof t.end?t.end:Date.parse(t.end),d=a[O].findItem(l);if(d&&m>l){n.itemStart=d.getLayoutLocation(l);var p=a[O].findItem(m);n.itemEnd=p?p.getLayoutLocation(m):m>=a[O].$endTime?a[O].$lastScale.$layoutEnd:d.$layoutStart,n.itemSize=n.itemEnd-n.itemStart;var h=i.item.cloneNode(!0);h&&(t.id&&h.setAttribute("data-item-id",t.id),e.appendChild(h),o.push(h),F.call(a,h,"r:dync",r,t,n))}n.itemIndex++}n.itemLocalIndex++}));var u=n.itemZoneSize=i.getSize(e);c>0&&o.forEach((function(t){var e=i.getSize(t);i.setTransform(t,(u-e)/2,0)})),n.itemLocalIndex=s}function V(t,e,r){var n=this.template,a=n.caption.cloneNode(!0);e.appendChild(a),F.call(this,a,"r:dync",t,{},r);var i=n.getSize(e),o=n.getSize(a);n.setTransform(a,(i-o)/2,0)}var Z={horizontal:{getSize:function(t){return t?(t.getBBox||t.getBoundingClientRect).call(t,{stroke:!0}).height:0},setTransform:function(t,e,r){t&&t.setAttribute("transform","matrix(1,0,0,1,".concat(Number(r)||0,",").concat(Number(e)||0,")"))}},vertical:{getSize:function(t){return t?(t.getBBox||t.getBoundingClientRect).call(t,{stroke:!0}).width:0},setTransform:function(t,e,r){t&&t.setAttribute("transform","matrix(1,0,0,1,".concat(Number(e)||0,",").concat(Number(r)||0,")"))}}};function Y(){var t,e=this.template.global,r=this.svg.querySelector("[r\\:tag='sample-projects']");if(r)try{(r=JSON.parse(String(r.innerHTML).replace(/(^[^\{]*)|([^\}]*$)/g,"")))instanceof Array||(r=[r])}catch(t){r=L}else r=L;return{itemMargin:Number(e.getAttribute("r:item-margin"))||0,projectMargin:Number(e.getAttribute("r:project-margin"))||0,sampleProjects:r,maxZoneSize:Number(this.zone.getAttribute("r:max-size"))||0,primeDateMap:(t=this.zone.getAttribute("r:prime-date-map"),t&&String(t).trim())}}function U(t,e){var r={};if(t<=e)for(var n=e.getFullYear(),a=e.getMonth(),i=t.getFullYear(),o=t.getMonth();i<=n;i++,o=0){var s=i<n?12-o:a-o+1;r[i]=s}return r}var H=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),c(e instanceof Node&&e.isConnected,"_container must be an Node connected to a DOM tree"),c(r instanceof SVGSVGElement,"_svgTemplate must be an instance of <SVG>"),e.innerHTML="",e.appendChild(r);var n=r.querySelector("[r\\:tag='roadmap-zone']"),a=r.querySelector("[r\\:tag='project-template']");c(n&&a,"incorrect template"),l(this,O,new T(r));var i=new Map;o(r.querySelectorAll("[r\\:dync]")).forEach((function(t,e){var r="dync".concat(e);i.set(r,P(t.getAttribute("r:dync"))),t.setAttribute("r:dync",r)})),o(r.querySelectorAll("[r\\:dync-project]")).forEach((function(t,e){var r="zone".concat(e);i.set(r,P(t.getAttribute("r:dync-project"))),t.setAttribute("r:dync-project",r)})),l(this,q,i);var s=a.querySelector("[r\\:tag='project-group']"),u=a.querySelector("[r\\:tag='project-caption']"),f=a.querySelector("[r\\:tag='project-item-zone']"),m=a.querySelector("[r\\:tag='project-item']");c(s&&u&&f&&m,"incorrect template"),s.remove(),u.remove(),f.remove(),m.remove();var d=Z["vertical"===a.getAttribute("r:grow-direction")?"vertical":"horizontal"],p=o(r.querySelectorAll("[r\\:dync-global]"));p.forEach((function(t,e){var r="global".concat(e);i.set(r,P(t.getAttribute("r:dync-global"))),t.setAttribute("r:dync-global",r)})),a.remove(),l(this,{svg:r,zone:n,template:Object.freeze({global:a,projectGroup:s,caption:u,itemZone:f,item:m,dyncGlobals:p,getSize:d.getSize,setTransform:d.setTransform})}),l(this,"parameters",Y.call(this))}var e,a,i,u,f;return e=t,a=[{key:"startTime",get:function(){return new Date(this[O].$startTime)},set:function(t){this[O].modifyTime(t)}},{key:"endTime",get:function(){return new Date(this[O].$endTime)}},{key:"setPrimeDate",value:function(t){t=new Date(t);var e=this.parameters.primeDateMap?new Function("year","month","day","return ".concat(this.parameters.primeDateMap)):void 0;this.startTime=e?new Date(e(t.getFullYear(),t.getMonth()+1,t.getDate())):t}},{key:"setTimeScales",value:function(t){this[O].setTimeScales(t)}},{key:"restoreTimeScales",value:function(){this[O].restoreTimeScales()}},{key:"setTimeScalesDisplay",value:function(t){this[O].setDisplay(t)}},{key:"restoreTimeScalesDisplay",value:function(){this[O].restoreDisplay()}},{key:"clear",value:function(){this.zone.innerHTML=""}},{key:"showProject",value:function(){for(var t=this,e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];var a=r.length;if(a>0){this.clear();var i=0,o=this.template,s={};try{r.forEach((function(e,r){var n={projectIndex:r,itemIndex:0},c=o.projectGroup.cloneNode(!0);if(c){t.zone.appendChild(c);var u=c.querySelector("[r\\:tag='project-zone']")||c,l=o.itemZone.cloneNode(!1);u.appendChild(l);var f=e.items;if(f instanceof Array&&B.call(t,f,l,e,n),V.call(t,e,u,n),n.projectZoneSize=o.getSize(u),c.setAttribute("data-project-index",r),e.id&&c.setAttribute("data-project-id",e.id),F.call(t,c,"r:dync-project",e,{},n),n.projectSize=o.getSize(c),t.parameters.maxZoneSize>0){var m=parseInt(t.parameters.maxZoneSize-n.projectSize-o.getSize(t.zone));0===m?r<a-1&&(s.index=r+1):m<0&&(c.remove(),s.index=r)}if(c.isConnected&&(o.setTransform(c,i,0),n.globalZoneSize=o.getSize(t.zone),o.dyncGlobals.forEach((function(i){if(G.call(t,i,"r:dync-global",e,{},n)===E&&r<a-1)throw s.index=r+1,s})),i+=o.getSize(c)+t.parameters.projectMargin),void 0!==s.index)throw s}}))}catch(t){if(t===s)return r.slice(s.index)}}}},{key:"showProjects",value:function(t){return t instanceof Array&&this.showProject.apply(this,t)}},{key:"showSample",value:function(){return this.showProject.apply(this,this.parameters.sampleProjects)}},{key:"toImage",value:function(){var t=this;return new Promise((function(e,r){var n='<?xml version="1.0" standalone="no"?>\r\n'+(new XMLSerializer).serializeToString(t.svg),a=new Image;a.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),a.onload=function(){return e(a)},a.onerror=function(t){return r(t)}}))}},{key:"toImageData",value:(u=s.mark((function t(e){return s.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.toImage().then((function(t){var r=t.width,n=t.height,a=document.createElement("canvas");a.width=r,a.height=n;var i=a.getContext("2d");return i.fillStyle="rgba(255,255,255,0)",i.fillRect(0,0,r,n),i.drawImage(t,0,0),{width:r,height:n,data:a.toDataURL("image/".concat(e||"png"))}})));case 1:case"end":return t.stop()}}),t,this)})),f=function(){var t=this,e=arguments;return new Promise((function(n,a){var i=u.apply(t,e);function o(t){r(i,n,a,o,s,"next",t)}function s(t){r(i,n,a,o,s,"throw",t)}o(void 0)}))},function(t){return f.apply(this,arguments)})}],i=[{key:"inferPrimeYear",value:function(){for(var t={},e=function e(r){if(r instanceof Array)r.forEach(e);else{var n=U(new Date(r.start),new Date(r.end));for(var a in n){var i=n[a],o=t[a];(!o||o<i)&&(t[a]=i)}}},r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];n.forEach((function(t){return t.items.forEach(e)}));var i=Number.MAX_SAFE_INTEGER,o=0;for(var s in t){var c=t[s];(c>o||c===o&&s<i)&&(i=s,o=c)}return i}}],a&&n(e.prototype,a),i&&n(e,i),t}();return a(H,"VERSION","1.0.0"),a(H,"STAMP","STAMP".concat(1622539865276)),H}));
//# sourceMappingURL=index.js.map
